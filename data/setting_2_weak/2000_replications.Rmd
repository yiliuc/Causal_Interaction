---
output: pdf_document
header-includes:
  - \usepackage{tikz}
  - \usetikzlibrary{arrows.meta,shapes,positioning}
  - \tikzset{node font = \large\bfseries\sffamily, 
         every node/.append style = {circle, minimum size = 12mm, thick},
         every edge/.append style = {->, very thick, shorten >= 1pt, shorten <= 1pt}}
---

```{r, echo=FALSE, message=FALSE}
library(purrr)

results_control_all <- get(load("outputs/all_beta_and_coverage/2000_control_reri.Rdata")[1])
results_both_all <- get(load("outputs/all_beta_and_coverage/2000_both_reri.Rdata")[1])
source("scripts/summary_table/summary_fitting_once.R")
source("scripts/kable_graph/making_kable.R")
source("scripts/kable_graph/bias_graph.R")

population_truth <- get(load("outputs/population_truth.Rdata"))
```

# Testing different models for *weak* confounding effects case 2 (fitting 2000 times)

\begin{figure}[htbp]
\centering
\begin{tikzpicture}

\node[draw, circle] (XG) at (0,2) {$\mathbf{X}_G$};
\node[draw, circle] (C)  at (0,0) {$\mathbf{C}$};
\node[draw, circle] (XE) at (0,-2) {$\mathbf{X}_E$};
\node[draw, circle] (XY) at (7,0) {$\mathbf{X}_Y$};

\node[draw, circle] (G)  at (2,1) {$G$};
\node[draw, circle] (E)  at (2,-1) {$E$};

\node[draw, circle] (Y)  at (4,0) {$Y$};

\draw[-Latex] (XG) -- (G);
\draw[-Latex] (XE) -- (E);
\draw[-Latex] (C) -- (G);
\draw[-Latex] (C) -- (E);
\draw[-Latex] (C) -- (Y);
\draw[-Latex] (G) -- (Y);
\draw[-Latex] (E) -- (Y);
\draw[-Latex] (XY) -- (Y);

\end{tikzpicture}
\caption{Directed Acyclic Graphs for causal interactions under two treatments G and E.}
\label{fig:markov-chain}
\end{figure}

Let $G$ and $E$ denote the two binary treatments and $Y$ be the binary outcome. Let $\mathbf{X}_G$, $\mathbf{X}_E$ be the set of instrumental variables for $G$ and $E$, respectively. Let $\mathbf{X}_Y$ be the outcome-only covariates. Let $\mathbf{C}$ be the set of common confounders to both treatments.

## Data generation

In this study, we will assume the outcome $Y$ is binary and there are two treatments $G$ and $E$. Let $\mathbf{X}_G=\{X_1,X_2\}$, $\mathbf{X}_E=\{X_3,X_4\}$, $\mathbf{X}_Y=\{X_5,X_6\}$ and $\mathbf{C}=\{X_7,X_8\}$. Suppose $\mathbf{X}=\{X_1,\ldots,X_8\}$ is generated to follow a multivariate normal distribution such that $\mathbf{X}\sim\mathcal{N}_8(\mathbf{0}, \mathbf{I}_8)$. To generate the treatment assignment probabilities, we firstly generate probabilities for each treatment individually:
$$
\begin{aligned}
& \pi_{G=1}=P(G=1 \mid \mathbf{Z}_G)=\frac{\exp\{f(\mathbf{Z}_G)\}}{1+\exp\{f(\mathbf{Z}_G)\}}\\
& \pi_{E=1}=P(E_i=1 \mid \mathbf{Z}_E)=\frac{\exp\{f(\mathbf{Z}_E)\}}{1+\exp\{f(\mathbf{Z}_E)\}}\\
\end{aligned}
$$
where $f(\mathbf{Z}_G)$ and $f(\mathbf{Z}_E)$ are the function of $\mathbf{Z}_G$ and $\mathbf{Z}_E$ such that $\mathbf{Z}_G=\{X_1,X_2,X_7,X_8\}$ and $\mathbf{Z}_E=\{X_3,X_4,X_7,X_8\}$. We now suppose 
$$
\begin{aligned}
f(\mathbf{Z}_G)&=0.8X_1+0.5X_2+0.3X_7+0.5X_8\\
f(\mathbf{X}_E)&=-0.5X_3+0.2X_4+0.3X_7+0.5X_8
\end{aligned}
$$
Note that here it is unnecessary to add the intercept as the expectation for each covariate is 0, making the marginal probabilities $\pi_{G=1}$ and $\pi_{E=1}$ are approximately 0.5. With the above setups, the probability of assignment for each combination of treatments can be computed as
$$
\begin{aligned}
\theta_{00}=p_{G=0,E=0}&=(1-\pi_{G=1})(1-\pi_{E=1})\\
\theta_{10}=p_{G=1,E=0}&=\pi_{G=1}(1-\pi_{E=1})\\
\theta_{01}=p_{G=0,E=1}&=(1-\pi_{G=1})\pi_{E=1}\\
\theta_{11}=p_{G=1,E=1}&=\pi_{G=1}\pi_{E=1}\\
\end{aligned}
$$
For each observation, the probability of receiving each pair of treatment follows a multinomial distribution such that $T_i\mid\mathbf{X}\sim\operatorname{Multinomial}(1,\theta_{00},\theta_{10},\theta_{01},\theta_{11})$, where $T_i\in\{(0,0),(1,0),(0,1),(1,1)\}$. In addition, denote $\mathbf{Z}_Y=\{\mathbf{X}_Y,\mathbf{C}\}=\{X_5,X_6,X_7,X_8\}$, the outcome is generated as
$$
\begin{aligned}
\operatorname{Pr}(Y=1 \mid \mathbf{Z}_Y, G, E)=\operatorname{logit}^{-1}(&\beta_0+\\
&0.8X_5+0.5X_6-0.05X_7+0.05X_8\\
&+0.3G+0.4E+0.8GE)
\end{aligned}
$$
The true value of conditional RERI in terms of odds ratio can be computed as $\exp\{0.3 + 0.4 + 0.8\}-\exp\{0.3\}-\exp\{0.4\}+1=2.64$.


\newpage

## Using control only

### $\beta_0=-6$: prevalence $\approx0.01$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-6)
make_reri_table(results_control_all$`-6`, beta0 = -6)
```

### $\beta_0=-5.5$: prevalence $\approx0.018$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-4.5)
make_reri_table(results_control_all$`-5.5`, beta0 = -5.5)
```


\newpage


### $\beta_0=-5$: prevalence $\approx0.03$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-3.7)
make_reri_table(results_control_all$`-5`, beta0 = -5)
```

### $\beta_0=-4.5$: prevalence $\approx0.05$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-3)
make_reri_table(results_control_all$`-4.5`, beta0 = -4.5)
```


\newpage


### $\beta_0=-4$: prevalence $\approx0.08$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-2)
make_reri_table(results_control_all$`-4`, beta0 = -4)
```

### $\beta_0=-3$: prevalence $\approx0.18$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-1)
make_reri_table(results_control_all$`-3`, beta0 = -3)
```


\newpage



### $\beta_0=-2$: prevalence $\approx0.4$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-1)
make_reri_table(results_control_all$`-2`, beta0 = -2)
```

### $\beta_0=-1$: prevalence $\approx0.6$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-1)
make_reri_table(results_control_all$`-1`, beta0 = -1)
```


\newpage


## Using both control and case

### $\beta_0=-6$: prevalence $\approx0.01$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-6)
make_reri_table(results_both_all$`-6`, beta0 = -6)
```

### $\beta_0=-5.5$: prevalence $\approx0.018$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-4.5)
make_reri_table(results_both_all$`-5.5`, beta0 = -5.5)
```


\newpage


### $\beta_0=-5$: prevalence $\approx0.03$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-3.7)
make_reri_table(results_both_all$`-5`, beta0 = -5)
```

### $\beta_0=-4.5$: prevalence $\approx0.05$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-3)
make_reri_table(results_both_all$`-4.5`, beta0 = -4.5)
```


\newpage


### $\beta_0=-4$: prevalence $\approx0.08$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-2)
make_reri_table(results_both_all$`-4`, beta0 = -4)
```

### $\beta_0=-3$: prevalence $\approx0.18$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-1)
make_reri_table(results_both_all$`-3`, beta0 = -3)
```


\newpage


### $\beta_0=-2$: prevalence $\approx0.4$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-1)
make_reri_table(results_both_all$`-2`, beta0 = -2)
```

### $\beta_0=-1$: prevalence $\approx0.6$

```{r, warning=FALSE, echo=FALSE, message=FALSE}
# making_prevalence_table(-1)
make_reri_table(results_both_all$`-1`, beta0 = -1)
```


\newpage

# Graphs

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(latex2exp)

# default_LOM <- compute_b3_bias("Default LOM", results_both_all, population_truth)
# CLOM_all <- compute_b3_bias("CLOM(X5678)", results_both_all, population_truth)
# MSLOM_all <- compute_b3_bias("MSLOM(all)", results_both_all, population_truth)
# DR <- compute_b3_bias("DR", results_both_all, population_truth)

model_names <- c("Default LOM", "CLOM(X5678)", "MSLOM(X5678)", "DR")

merged_bias <- model_names %>% 
  map(~ compute_b3_bias(.x, results_control_all, population_truth))  %>% 
  reduce(full_join, by = "beta0")

bias_long <- merged_bias %>% 
  pivot_longer(
    -beta0,
    names_to   = "Model",
    values_to  = "bias"
  )

ggplot(bias_long,
       aes(x = beta0, 
           y = bias,
           colour = Model,
           linewidth = Model,
           size = Model,
           alpha = Model)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  scale_colour_manual(values = c("Default LOM" = "black",
                                 "CLOM(X5678)"   = "lightblue",
                                 "MSLOM(X5678)"  = "blue",
                                 "DR" = "grey")) +
  scale_alpha_manual(values = c("Default LOM" = 1,
                                "CLOM(X5678)" = 0.2,
                                "MSLOM(X5678)" = 1,
                                "DR" = 0.2)) +
  labs(x = expression(beta[0]),
       y = "Bias (%)",
       title = TeX("Bias of $RERI_{OR}$ across models, with weights using control data only")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor = element_blank())
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
model_names <- c("Default LOM", "CLOM(X5678)", "MSLOM(X5678)", "DR")

merged_bias <- model_names %>% 
  map(~ compute_b3_bias(.x, results_both_all, population_truth))  %>% 
  reduce(full_join, by = "beta0")

bias_long <- merged_bias %>% 
  pivot_longer(
    -beta0,
    names_to   = "Model",
    values_to  = "bias"
  )

ggplot(bias_long,
       aes(x = beta0, 
           y = bias,
           colour = Model,
           linewidth = Model,
           size = Model,
           alpha = Model)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  scale_colour_manual(values = c("Default LOM" = "black",
                                 "CLOM(X5678)"   = "lightblue",
                                 "MSLOM(X5678)"  = "blue",
                                 "DR" = "grey")) +
  scale_alpha_manual(values = c("Default LOM" = 1,
                                "CLOM(X5678)" = 0.2,
                                "MSLOM(X5678)" = 1,
                                "DR" = 0.2)) +
  labs(x = expression(beta[0]),
       y = "Bias (%)",
       title = TeX("Bias of $RERI_{OR}$ across models, with weights using both data")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor = element_blank())
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
model_names <- c("Default LOM", "MSLOM(X7X8)", "MSLOM(X1278)", "MSLOM(X3478)", "MSLOM(X5678)", "MSLOM(X123478)", "MSLOM(all)")

merged_bias <- model_names %>% 
  map(~ compute_b3_bias(.x, results_control_all, population_truth))  %>% 
  reduce(full_join, by = "beta0")

bias_long <- merged_bias %>% 
  pivot_longer(
    -beta0,
    names_to   = "Model",
    values_to  = "bias"
  )

ggplot(bias_long,
       aes(x = beta0, 
           y = bias,
           colour = Model,
           linewidth= Model,
           size = Model,
           alpha = Model)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  scale_colour_manual(values = c("Default LOM" = "black",
                                 "MSLOM(X7X8)" = "red",
                                 "MSLOM(X1278)" = "lightgrey",
                                 "MSLOM(X3478)" = "darkgrey",
                                 "MSLOM(X5678)" = "blue",
                                 "MSLOM(X123478)" = "#E69F00",
                                 "MSLOM(all)" = "#56B4E9")) +
  scale_alpha_manual(values = c("Default LOM" = 1,
                                "MSLOM(X7X8)" = 1,
                                "MSLOM(X1278)" = 0.2,
                                "MSLOM(X3478)" = 0.2,
                                "MSLOM(X5678)" = 1,
                                "MSLOM(X123478)" = 0.2,
                                "MSLOM(all)" = 0.2)) +
  labs(x = expression(beta[0]),
       y = "Bias (%)",
       title = TeX("Bias of $RERI_{OR}$ across MSLOM models, with weights using control data only")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor = element_blank())
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
model_names <- c("Default LOM", "MSLOM(X7X8)", "MSLOM(X1278)", "MSLOM(X3478)", "MSLOM(X5678)", "MSLOM(X123478)", "MSLOM(all)")

merged_bias <- model_names %>% 
  map(~ compute_b3_bias(.x, results_both_all, population_truth))  %>% 
  reduce(full_join, by = "beta0")

bias_long <- merged_bias %>% 
  pivot_longer(
    -beta0,
    names_to   = "Model",
    values_to  = "bias"
  )

ggplot(bias_long,
       aes(x = beta0, 
           y = bias,
           colour = Model,
           linewidth= Model,
           size = Model,
           alpha = Model)) +
  geom_line(linewidth = 0.8) +
  geom_point(size = 1.2) +
  scale_colour_manual(values = c("Default LOM" = "black",
                                 "MSLOM(X7X8)" = "red",
                                 "MSLOM(X1278)" = "lightgrey",
                                 "MSLOM(X3478)" = "darkgrey",
                                 "MSLOM(X5678)" = "blue",
                                 "MSLOM(X123478)" = "#E69F00",
                                 "MSLOM(all)" = "#56B4E9")) +
  scale_alpha_manual(values = c("Default LOM" = 1,
                                "MSLOM(X7X8)" = 1,
                                "MSLOM(X1278)" = 0.2,
                                "MSLOM(X3478)" = 0.2,
                                "MSLOM(X5678)" = 1,
                                "MSLOM(X123478)" = 0.2,
                                "MSLOM(all)" = 0.2)) +
  labs(x = expression(beta[0]),
       y = "Bias (%)",
       title = TeX("Bias of $RERI_{OR}$ across MSLOM models, with weights using both data")) +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor = element_blank())
```

